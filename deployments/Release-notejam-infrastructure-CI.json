{"source":2,"revision":35,"description":null,"createdBy":{"displayName":"Yaroslav Yakushev","url":"https://spsprodcus3.vssps.visualstudio.com/A20972d6f-7c68-479f-97e8-41a9342f7d88/_apis/Identities/56fe3083-df8d-4eed-bb20-b6765258087d","_links":{"avatar":{"href":"https://yyakushev-outlook.visualstudio.com/_apis/GraphProfile/MemberAvatars/msa.NDZlOGVkYTctYTc3NS03ODJlLWE1ZmUtM2VlOTI4YzdmNTEy"}},"id":"56fe3083-df8d-4eed-bb20-b6765258087d","uniqueName":"yyakushev@outlook.com","imageUrl":"https://yyakushev-outlook.visualstudio.com/_apis/GraphProfile/MemberAvatars/msa.NDZlOGVkYTctYTc3NS03ODJlLWE1ZmUtM2VlOTI4YzdmNTEy","descriptor":"msa.NDZlOGVkYTctYTc3NS03ODJlLWE1ZmUtM2VlOTI4YzdmNTEy"},"createdOn":"2019-09-12T14:35:05.827Z","modifiedBy":{"displayName":"Yaroslav Yakushev","url":"https://spsprodcus3.vssps.visualstudio.com/A20972d6f-7c68-479f-97e8-41a9342f7d88/_apis/Identities/56fe3083-df8d-4eed-bb20-b6765258087d","_links":{"avatar":{"href":"https://yyakushev-outlook.visualstudio.com/_apis/GraphProfile/MemberAvatars/msa.NDZlOGVkYTctYTc3NS03ODJlLWE1ZmUtM2VlOTI4YzdmNTEy"}},"id":"56fe3083-df8d-4eed-bb20-b6765258087d","uniqueName":"yyakushev@outlook.com","imageUrl":"https://yyakushev-outlook.visualstudio.com/_apis/GraphProfile/MemberAvatars/msa.NDZlOGVkYTctYTc3NS03ODJlLWE1ZmUtM2VlOTI4YzdmNTEy","descriptor":"msa.NDZlOGVkYTctYTc3NS03ODJlLWE1ZmUtM2VlOTI4YzdmNTEy"},"modifiedOn":"2019-09-13T02:08:54.787Z","isDeleted":false,"lastRelease":{"id":58,"name":"Release-25","artifacts":[],"_links":{},"description":"","releaseDefinition":{"id":6,"projectReference":null,"_links":{}},"createdOn":"2019-09-13T00:19:52.807Z","createdBy":{"displayName":"Yaroslav Yakushev","url":"https://spsprodcus3.vssps.visualstudio.com/A20972d6f-7c68-479f-97e8-41a9342f7d88/_apis/Identities/56fe3083-df8d-4eed-bb20-b6765258087d","_links":{"avatar":{"href":"https://yyakushev-outlook.visualstudio.com/_apis/GraphProfile/MemberAvatars/msa.NDZlOGVkYTctYTc3NS03ODJlLWE1ZmUtM2VlOTI4YzdmNTEy"}},"id":"56fe3083-df8d-4eed-bb20-b6765258087d","uniqueName":"yyakushev@outlook.com","imageUrl":"https://yyakushev-outlook.visualstudio.com/_apis/GraphProfile/MemberAvatars/msa.NDZlOGVkYTctYTc3NS03ODJlLWE1ZmUtM2VlOTI4YzdmNTEy","descriptor":"msa.NDZlOGVkYTctYTc3NS03ODJlLWE1ZmUtM2VlOTI4YzdmNTEy"}},"variables":{},"variableGroups":[2],"environments":[{"id":6,"name":"Stage 1","rank":1,"owner":{"displayName":"Yaroslav Yakushev","url":"https://spsprodcus3.vssps.visualstudio.com/A20972d6f-7c68-479f-97e8-41a9342f7d88/_apis/Identities/56fe3083-df8d-4eed-bb20-b6765258087d","_links":{"avatar":{"href":"https://yyakushev-outlook.visualstudio.com/_apis/GraphProfile/MemberAvatars/msa.NDZlOGVkYTctYTc3NS03ODJlLWE1ZmUtM2VlOTI4YzdmNTEy"}},"id":"56fe3083-df8d-4eed-bb20-b6765258087d","uniqueName":"yyakushev@outlook.com","imageUrl":"https://yyakushev-outlook.visualstudio.com/_apis/GraphProfile/MemberAvatars/msa.NDZlOGVkYTctYTc3NS03ODJlLWE1ZmUtM2VlOTI4YzdmNTEy","descriptor":"msa.NDZlOGVkYTctYTc3NS03ODJlLWE1ZmUtM2VlOTI4YzdmNTEy"},"variables":{},"variableGroups":[],"preDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":16}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":1}},"deployStep":{"id":17},"postDeployApprovals":{"approvals":[{"rank":1,"isAutomated":true,"isNotificationOn":false,"id":18}],"approvalOptions":{"requiredApproverCount":null,"releaseCreatorCanBeApprover":false,"autoTriggeredAndPreviousEnvironmentApprovedCanBeSkipped":false,"enforceIdentityRevalidation":false,"timeoutInMinutes":0,"executionOrder":2}},"deployPhases":[{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":{"identifier":"ubuntu-16.04"},"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[{"alias":"_notejam-test-CI","artifactType":"Build","artifactDownloadMode":"All","artifactItems":[]}]},"queueId":39,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":1,"phaseType":1,"name":"Infrastructure deployment","refName":null,"workflowTasks":[{"environment":{},"taskId":"46e4be58-730b-4389-8a2f-ea10b3e5e815","version":"1.*","name":"Azure CLI","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"connectedServiceNameARM":"348f405c-730c-4299-b9a8-f6b878c7225f","scriptLocation":"inlineScript","scriptPath":"$(System.DefaultWorkingDirectory)/_notejam-test-CI/infra/infra.sh","inlineScript":"#!/bin/bash\n\nprojectname=$1\nprojectuniqeid=$2\n\nresourcegroupname=\"$projectname-rg\"\nazcontainerregistryname=\"azcr$projectname\"\nappserviceplanname=\"$projectname-asp\"\nappname=\"$projectname-$projectuniqeid\"\nstorageaccountname=\"storage$projectname$projectuniqeid\"\nmountpath=\"/home/site/wwwroot/notejam/db/\"\n\naz group create --name $resourcegroupname --location \"West Europe\"\n\naz acr create --name $azcontainerregistryname --resource-group $resourcegroupname --sku Basic --admin-enabled true\n\n#azccred=$(az acr credential show --name $azcontainerregistryname --query passwords[0].value -o json)\n\naz appservice plan create --name $appserviceplanname --resource-group $resourcegroupname --sku S1 --is-linux\naz webapp create --resource-group $resourcegroupname --plan $appserviceplanname  --name $appname --deployment-container-image-name \"$azcontainerregistryname.azurecr.io/notejam-flask:105\"\n\naz webapp config container set --name $appname --resource-group $resourcegroupname --docker-custom-image-name \"DOCKER|appsvcsample/static-site\" --docker-registry-server-url \"https://index.docker.io\" --docker-registry-server-user $azcontainerregistryname #--docker-registry-server-password 'u9Ru8el4PCMucP/8H7ccrZZJcCnh3pJ4'\n\naz webapp config appsettings set --resource-group $resourcegroupname --name $appname --settings WEBSITES_PORT=80 #WEBSITES_ENABLE_APP_SERVICE_STORAGE=false\naz webapp config appsettings set --resource-group $resourcegroupname --name $appname --settings MODULE_NAME=runserver\n\n#configure persist storage\naz storage account create --name $storageaccountname --resource-group  $resourcegroupname\naz storage container create --name $appname --account-name $storageaccountname\nstoragekeys=$(az storage account keys list --account-name $storageaccountname --query [0].value)\n\naz webapp config storage-account add --resource-group $resourcegroupname --name $appname --custom-id \"dbstorage\" --storage-type AzureBlob --share-name $appname --account-name $storageaccountname --access-key $storagekeys --mount-path $mountpath\naz webapp config storage-account list --resource-group $resourcegroupname --name $appname\n\n#configure log\naz webapp log config --name $appname --resource-group $resourcegroupname --docker-container-logging filesystem\n\n#configure autoscale\naz monitor autoscale create --resource-group $resourcegroupname --name \"${appname}-AutoscaleSettings\" --min-count 1 --max-count 4 --count 1 --resource-type Microsoft.Web/serverFarms --resource $appserviceplanname\n\naz monitor autoscale rule create --resource-group $resourcegroupname --autoscale-name \"${appname}-AutoscaleSettings\" --scale out 1 --condition \"CpuPercentage > 75 avg 5m\"\n\naz monitor autoscale rule create --resource-group $resourcegroupname --autoscale-name \"${appname}-AutoscaleSettings\" --scale in 1 --condition \"CpuPercentage < 25 avg 5m\"","args":"$(projectname) $(projectuniqeid)","addSpnToEnvironment":"false","useGlobalConfig":"false","cwd":"$(System.DefaultWorkingDirectory)/_notejam-test-CI/infra","failOnStandardError":"false"}}]},{"deploymentInput":{"parallelExecution":{"parallelExecutionType":0},"agentSpecification":{"identifier":"vs2017-win2016"},"skipArtifactsDownload":false,"artifactsDownloadInput":{"downloadInputs":[]},"queueId":39,"demands":[],"enableAccessToken":false,"timeoutInMinutes":0,"jobCancelTimeoutInMinutes":1,"condition":"succeeded()","overrideInputs":{}},"rank":2,"phaseType":1,"name":"Runbook configuration","refName":null,"workflowTasks":[{"environment":{},"taskId":"72a1931b-effb-4d2e-8fd8-f8472a07cb62","version":"3.*","name":"Azure PowerShell script: InlineScript","refName":"","enabled":true,"alwaysRun":false,"continueOnError":false,"timeoutInMinutes":0,"definitionType":"task","overrideInputs":{},"condition":"succeeded()","inputs":{"ConnectedServiceNameSelector":"ConnectedServiceNameARM","ConnectedServiceName":"","ConnectedServiceNameARM":"d34fb1e6-9cd8-4c28-bd5f-b05a54dde8b5","ScriptType":"InlineScript","ScriptPath":"","Inline":"# You can write your azure powershell scripts inline here. \n# You can also pass predefined and custom variables to this script using arguments\n\n$resourcegroupname=\"$(projectname)-rg\"\n$AutomationAccountName=\"AA$(projectname)\"\n$RunbookPath=\"$(System.DefaultWorkingDirectory)/_notejam-test-CI/infra/Runbook.ps1\"\n$storageAccountName=\"storage$(projectname)$(projectuniqeid)\"\n$StorageContainer=\"$(projectname)-$(projectuniqeid)\"\n\nNew-AzureRmAutomationAccount -ResourceGroupName $resourcegroupname -Name $AutomationAccountName -Location \"westeurope\"\nif (!(get-AzureRmAutomationRunbook -ResourceGroupName $resourcegroupname -Name notejamdbbackup -AutomationAccountName $AutomationAccountName -ErrorAction SilentlyContinue)) {\n    Import-AzureRmAutomationRunbook -ResourceGroupName $resourcegroupname -Name notejamdbbackup -Published -Path $RunbookPath -AutomationAccountName $AutomationAccountName -Type PowerShell\n}\n\n$storageAccountKey = (Get-AzureRmStorageAccountKey -ResourceGroupName $resourcegroupname  -AccountName $storageAccountName).Value[0]\n\n$StartTime = Get-Date \"01:00:00\"\nif (!(get-AzureRmAutomationSchedule -ResourceGroupName $resourcegroupname -AutomationAccountName $AutomationAccountName -ErrorAction SilentlyContinue)) {\n    New-AzureRmAutomationSchedule -ResourceGroupName $resourcegroupname -AutomationAccountName $AutomationAccountName `\n        -Name \"Daily-$StorageContainer-backup\" -StartTime $StartTime -DayInterval 1 \n}\n\nRegister-AzureRmAutomationScheduledRunbook -AutomationAccountName $AutomationAccountName -Name notejamdbbackup `\n    -ScheduleName \"Daily-$StorageContainer-backup\" -ResourceGroupName $resourcegroupname `\n    -Parameters @{StorageContainer=$StorageContainer;StorageAccount=$storageAccountName;StorageKey=$storageAccountKey}","ScriptArguments":"","errorActionPreference":"stop","FailOnStandardError":"false","TargetAzurePs":"OtherVersion","CustomTargetAzurePs":"5.1.1"}}]}],"environmentOptions":{"emailNotificationType":"OnlyOnFailure","emailRecipients":"release.environment.owner;release.creator","skipArtifactsDownload":false,"timeoutInMinutes":0,"enableAccessToken":false,"publishDeploymentStatus":true,"badgeEnabled":false,"autoLinkWorkItems":false,"pullRequestDeploymentEnabled":false},"demands":[],"conditions":[{"name":"ReleaseStarted","conditionType":1,"value":""}],"executionPolicy":{"concurrencyCount":1,"queueDepthCount":0},"schedules":[],"currentRelease":{"id":58,"url":"https://yyakushev-outlook.vsrm.visualstudio.com/eedf34ee-0662-40c5-9802-5b9bd11f5221/_apis/Release/releases/58","_links":{}},"retentionPolicy":{"daysToKeep":30,"releasesToKeep":3,"retainBuild":true},"processParameters":{},"properties":{},"preDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"postDeploymentGates":{"id":0,"gatesOptions":null,"gates":[]},"environmentTriggers":[],"badgeUrl":"https://yyakushev-outlook.vsrm.visualstudio.com/_apis/public/Release/badge/eedf34ee-0662-40c5-9802-5b9bd11f5221/6/6"}],"artifacts":[{"sourceId":"eedf34ee-0662-40c5-9802-5b9bd11f5221:19","type":"Build","alias":"_notejam-test-CI","definitionReference":{"artifactSourceDefinitionUrl":{"id":"https://yyakushev-outlook.visualstudio.com/_permalink/_build/index?collectionId=5bab3880-5453-4ec5-91fc-b6375fc68ec0&projectId=eedf34ee-0662-40c5-9802-5b9bd11f5221&definitionId=19","name":""},"defaultVersionBranch":{"id":"","name":""},"defaultVersionSpecific":{"id":"","name":""},"defaultVersionTags":{"id":"","name":""},"defaultVersionType":{"id":"latestType","name":"Latest"},"definition":{"id":"19","name":"notejam-test-CI"},"definitions":{"id":"","name":""},"IsMultiDefinitionType":{"id":"False","name":"False"},"project":{"id":"eedf34ee-0662-40c5-9802-5b9bd11f5221","name":"Notejam"},"repository":{"id":"","name":""}},"isPrimary":true,"isRetained":false}],"triggers":[],"releaseNameFormat":"Release-$(rev:r)","tags":[],"properties":{"DefinitionCreationSource":{"$type":"System.String","$value":"ReleaseNew"},"IntegrateJiraWorkItems":{"$type":"System.String","$value":"false"}},"id":6,"name":"notejam-infrastructure-CI","path":"\\","projectReference":null,"url":"https://yyakushev-outlook.vsrm.visualstudio.com/eedf34ee-0662-40c5-9802-5b9bd11f5221/_apis/Release/definitions/6","_links":{"self":{"href":"https://yyakushev-outlook.vsrm.visualstudio.com/eedf34ee-0662-40c5-9802-5b9bd11f5221/_apis/Release/definitions/6"},"web":{"href":"https://yyakushev-outlook.visualstudio.com/eedf34ee-0662-40c5-9802-5b9bd11f5221/_release?definitionId=6"}}}